#!/usr/bin/make -f

#export DH_VERBOSE=1

export DH_ALWAYS_EXCLUDE=.svn:SUSE:adodb

DEB_HOST_GNU_TYPE    ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE      ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

CFLAGS += -O2 -Wall -fno-strict-aliasing
LFSFLAGS += -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64

# Enable IEEE-conformant floating point math on alphas (not the default)
ifeq (alpha-linux-gnu,$(DEB_HOST_GNU_TYPE))
        CFLAGS += -mieee
endif

ifeq ($(DEB_HOST_GNU_TYPE), $(findstring $(DEB_HOST_GNU_TYPE), ia64-linux-gnu powerpc64-linux-gnu))
        CFLAGS += -g
else
        CFLAGS += -gstabs
endif

include /usr/share/quilt/quilt.make

debian/control: debian-templates-control
	
debian-templates-%:
	(cd debian/; \
        $(MAKE) -f Makefile.templates $*)

build: patch build-stamp

build-stamp:
	dh_testdir
	
	( cd tools/daemon; DAEMON_OPTIONS="$(DEB_BUILD_OPTIONS),nostrip" $(MAKE) ispcp_daemon CFLAGS="$(CFLAGS)")
	
	touch $@

clean: unpatch
	dh_testdir
	dh_testroot
	rm -f build-stamp
	
	#INST_PREF=$(CURDIR)/debian/tmp $(MAKE) uninstall
	( cd tools; $(MAKE) uninstall)
	$(RM) -r debian/tmp
	
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs
	
	INST_PREF=$(CURDIR)/debian/tmp $(MAKE) install


binary-s-%:
	dh_testdir
	dh_testroot
	dh_installchangelogs -$* CHANGELOG
	dh_installdocs -$* docs/VHCS_CHANGELOG docs/README
	dh_install -$*
	[ $* = i ] && $(RM) -r debian/ispcp-omega-gui/var/www/ispcp/gui/tools/{filemanager,pma,webmail} || true
	dh_installdebconf -$*
	dh_installinit -$*
	dh_installman -$*
	dh_installcron -$*
	dh_installlogrotate -$*
	dh_installlogcheck -$*
	dh_link -$*
	dh_strip -$*
	dh_compress -$*
	dh_fixperms -$*
	dh_perl -$* debian/ispcp-omega-backend/var/www/ispcp/engine/{ispcp_common_methods.pl,traffic/ispcp-vrl-traff,awstats/awstats_buildstaticpages.pl,setup/ispcp-setup,ispcp-dmn-mngr}
	dh_installdeb -$*
	dh_shlibdeps -$*
	dh_gencontrol -$*
	dh_md5sums -$*
	dh_builddeb -$*

binary-indep: install binary-s-i

binary-arch: build install binary-s-a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install debian-templates-% binary-s-%
